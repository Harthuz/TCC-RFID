@startuml
title Diagrama de Sequência: Detecção e Gerenciamento de Alteração de Estoque

autonumber

actor "Gerente" as Gerente
participant "Leitor RFID" as RFID <<Device>>
participant "Microcontrolador\n(ESP32)" as ESP32 <<Gateway IoT>>
participant "Backend\n(Node.js)" as Backend
database "Banco de Dados\n(Firebase)" as BD
participant "Dashboard\n(React)" as Dashboard
participant "Sistema de\nNotificação" as Notificacao

== Início do Fluxo: Alteração Física na Prateleira ==

RFID -> ESP32: Leitura contínua de tags (em loop)
activate ESP32

loop A cada X segundos ou por evento de trigger
    ESP32 -> ESP32: Compara lista de tags atual com a última lista salva
    alt Se a lista de tags mudou (produto adicionado ou removido)
        ESP32 -> Backend: POST /api/estoque/atualizar\n(lista_de_tags)
        activate Backend
        Backend -> BD: Buscar estado do estoque anterior
        activate BD
        BD --> Backend: Retornar dados do estoque anterior
        deactivate BD
        
        Backend -> Backend: Analisar diferença (itens adicionados/removidos)
        
        alt Se item removido
            Backend -> BD: UPDATE estoque (remover item)
            activate BD
            BD --> Backend: Confirmação de UPDATE
            deactivate BD
        else Se item adicionado
            Backend -> BD: UPDATE estoque (adicionar item)
            activate BD
            BD --> Backend: Confirmação de UPDATE
            deactivate BD
        end
        
        opt Se estoque baixo ou item vencendo
            Backend -> Notificacao: Trigger de alerta\n(mensagem)
            activate Notificacao
            Notificacao --> Gerente: Push Notification (alerta)
            deactivate Notificacao
        end
        
        Backend -> Dashboard: Envia WebSocket/Push\n(dados_atualizados)
        activate Dashboard
        Dashboard --> Dashboard: Atualiza interface de usuário
        deactivate Dashboard
        
        Backend --> ESP32: 200 OK (Confirmação da atualização)
        deactivate Backend
        
    else Não há alteração
        ESP32 -> ESP32: Nenhuma ação é necessária
    end
end
deactivate ESP32

@enduml